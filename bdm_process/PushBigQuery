import pandas as pd
from google.cloud import bigquery
from google.oauth2 import service_account
from pathlib import Path

from params import PROJECT_ID, DATASET_ID, TABLE_ID, brand, KEY_PATH

def get_data(brand=brand):

    print(f"üì• Chargement des donn√©es pour {brand}...")
    
    query = f"""
        SELECT *
        FROM `edhec-01.luxurydata2502.price-monitoring-2022`
        WHERE brand = '{brand}'
    """
    
    try:
        # Authentification avec le fichier de cl√©
        credentials = service_account.Credentials.from_service_account_file(KEY_PATH)
        client = bigquery.Client(credentials=credentials, project="projectbdm-487109")
        
        df = client.query(query).to_dataframe()
        print(f"‚úÖ {len(df)} lignes charg√©es depuis BigQuery.")
        return df
        
    except Exception as e:
        print(f"‚ùå Erreur de connexion BigQuery : {e}")
        raise e

def load_data_to_bq(df, table_name=TABLE_ID, replace=True):

    print(f"üíæ Pr√©paration de la sauvegarde vers {table_name}...")
    
    # Authentification avec le fichier de cl√©
    credentials = service_account.Credentials.from_service_account_file(KEY_PATH)
    client = bigquery.Client(credentials=credentials, project=PROJECT_ID)
    
    table_ref = f"{PROJECT_ID}.{DATASET_ID}.{table_name}"
    
    write_mode = "WRITE_TRUNCATE" if replace else "WRITE_APPEND"
    job_config = bigquery.LoadJobConfig(write_disposition=write_mode)
    
    try:
        job = client.load_table_from_dataframe(df, table_ref, job_config=job_config)
        job.result()
        print(f"‚úÖ Sauvegarde termin√©e avec succ√®s dans {table_ref}.")
        
    except Exception as e:
        print(f"‚ùå Erreur lors de l'√©criture dans BigQuery : {e}")
        raise e

if __name__ == "__main__":
    try:
        df = get_data("Patek Philippe")
        print(df.head())
        
        # Sauvegarde dans ta table
        load_data_to_bq(df)
        
    except Exception as e:
        print(f"Erreur : {e}")
